// This is your Prisma schema file for @ofeklabs/horizon-auth
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(cuid())
  email              String          @unique
  fullName           String?
  passwordHash       String?
  emailVerified      Boolean         @default(false)
  emailVerifyToken   String?         @unique
  resetToken         String?         @unique
  resetTokenExpiry   DateTime?
  tenantId           String          @default("default")
  roles              String[]        @default(["user"])
  isActive           Boolean         @default(true)
  deactivationReason String?
  refreshTokens      RefreshToken[]
  socialAccounts     SocialAccount[]
  devices            Device[]
  pushTokens         PushToken[]
  twoFactorAuth      TwoFactorAuth?
  backupCodes        BackupCode[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([email])
  @@index([tenantId])
  @@index([isActive])
  @@map("users")
}

model RefreshToken {
  id            String    @id @default(cuid())
  hashedToken   String    @unique
  userId        String
  deviceId      String?
  expiresAt     DateTime
  parentTokenId String?
  revoked       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  device        Device?   @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([deviceId])
  @@index([hashedToken])
  @@map("refresh_tokens")
}

model SocialAccount {
  id          String   @id @default(cuid())
  userId      String
  provider    String   // 'google' | 'facebook'
  providerId  String   // Provider's user ID
  email       String?
  displayName String?
  profileData Json?    // Additional profile info
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@map("social_accounts")
}

model Device {
  id            String         @id @default(cuid())
  userId        String
  deviceName    String?        // e.g., "iPhone 13"
  deviceType    String?        // 'mobile' | 'tablet' | 'desktop'
  os            String?        // e.g., "iOS 16.0"
  browser       String?        // e.g., "Safari 16.0"
  fingerprint   String         // Hash of user agent
  lastActiveAt  DateTime       @default(now())
  createdAt     DateTime       @default(now())
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokens RefreshToken[]
  pushTokens    PushToken[]

  @@index([userId])
  @@index([fingerprint])
  @@map("devices")
}

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  deviceId  String
  token     String   @unique
  tokenType String   // 'FCM' | 'APNS'
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
  @@index([active])
  @@map("push_tokens")
}

model TwoFactorAuth {
  id         String    @id @default(cuid())
  userId     String    @unique
  totpSecret String    // Encrypted TOTP secret
  enabled    Boolean   @default(false)
  enabledAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String    // Bcrypt hash of the code
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([used])
  @@map("backup_codes")
}
